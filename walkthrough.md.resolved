# LexAI Backend — Build Walkthrough

## Summary

Built the **entire LexAI backend** from scratch — a production-grade AI-powered contract intelligence SaaS platform. The codebase contains **68 source files** across 10 architectural layers.

## Architecture

```mermaid
graph TB
    Client["Client (Frontend)"]
    
    subgraph API["API Process (server.js)"]
        Routes --> Controllers --> Services
        MW["Middleware Chain<br/>auth → rbac → rate limit → validate"]
        Routes --> MW
    end
    
    subgraph Worker["Worker Process (worker.js)"]
        AnalysisWorker["Analysis Worker"]
        AlertWorker["Alert Worker"]
    end
    
    subgraph Infra["Infrastructure"]
        MongoDB[(MongoDB)]
        Redis[(Redis)]
        RabbitMQ[(RabbitMQ)]
    end
    
    OpenRouter["OpenRouter AI API"]
    
    Client -->|"HTTP/WS"| API
    API -->|"Pub jobs"| RabbitMQ
    RabbitMQ -->|"Consume"| Worker
    Worker -->|"AI calls"| OpenRouter
    Worker -->|"Pub/Sub events"| Redis
    Redis -->|"Socket bridge"| API
    Services --> MongoDB
    Services --> Redis
```

## Files Created (68 total)

| Layer | Count | Files |
|-------|-------|-------|
| Config | 5 | [env.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/env.js), [db.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/db.js), [redis.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/redis.js), [rabbitmq.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/rabbitmq.js), [socket.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/socket.js) |
| Constants | 4 | [roles.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/constants/roles.js), [queues.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/constants/queues.js), [plans.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/constants/plans.js), [httpStatus.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/constants/httpStatus.js) |
| Utils | 7 | `logger`, `apiResponse`, [asyncWrapper](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/utils/asyncWrapper.js#14-19), `tokenHelper`, `hashHelper`, `dateHelper`, `textExtractor` |
| Models | 7 | [User](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/controllers/admin.controller.js#94-113), [Organization](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/org.service.js#37-75), [Invitation](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/invitation.service.js#20-77), [Contract](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/controllers/contract.controller.js#69-80), [Analysis](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/analysis.service.js#126-138), `Notification`, [AuditLog](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/controllers/admin.controller.js#114-127) |
| Middleware | 7 | [auth](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/rbac.middleware.js#14-39), `rbac`, [rateLimiter](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/rateLimiter.middleware.js#18-70), `quota`, [validate](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/validate.middleware.js#15-46), [errorHandler](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/errorHandler.middleware.js#14-106), `requestLogger` |
| Validators | 4 | [auth](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/rbac.middleware.js#14-39), `contract`, `analysis`, [org](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/auth.service.js#164-184) |
| Services | 13 | [auth](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/rbac.middleware.js#14-39), `user`, [org](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/auth.service.js#164-184), `invitation`, `email`, `contract`, `analysis`, [ai](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/email.service.js#35-60), `diff`, `alert`, `quota`, `enrichment`, `audit` |
| Controllers | 7 | [auth](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/rbac.middleware.js#14-39), `user`, [org](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/auth.service.js#164-184), `contract`, `diff`, `analysis`, `admin` |
| Routes | 8 | [auth](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/middleware/rbac.middleware.js#14-39), `user`, [org](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/services/auth.service.js#164-184), `contract`, `analysis`, `health`, `admin`, `index` |
| Sockets | 2 | [events.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/sockets/events.js), [pubsub.subscriber.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/sockets/pubsub.subscriber.js) |
| Workers | 2 | [analysis.worker.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/workers/analysis.worker.js), [alert.worker.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/workers/alert.worker.js) |
| Jobs | 1 | [expiry.cron.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/jobs/expiry.cron.js) |
| Entry Points | 4 | [app.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/app.js), [server.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/server.js), [worker.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/worker.js), [scripts/seed.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/scripts/seed.js) |
| Docker | 3 | [Dockerfile](file:///c:/Users/vishal%20sanam/Downloads/LexAI/Dockerfile), [Dockerfile.worker](file:///c:/Users/vishal%20sanam/Downloads/LexAI/Dockerfile.worker), [docker-compose.yml](file:///c:/Users/vishal%20sanam/Downloads/LexAI/docker-compose.yml) |
| Config Files | 2 | [package.json](file:///c:/Users/vishal%20sanam/Downloads/LexAI/package.json), [.env.example](file:///c:/Users/vishal%20sanam/Downloads/LexAI/.env.example) |

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| **Refresh token rotation** | Each refresh token is single-use; reuse signals token theft |
| **Redis Pub/Sub bridge** | Workers can't access Socket.io; events flow Worker → Redis → API → Client |
| **Distributed lock** | Prevents duplicate AI analysis jobs for the same contract content |
| **Fail-open rate limiter** | If Redis is down, requests are allowed through rather than blocking all users |
| **Primary/fallback AI model** | Calls OpenRouter with retry + fallback to ensure analysis completion |
| **90-day TTL on audit logs** | MongoDB auto-deletes via TTL index; keeps storage predictable |
| **Content hash cache key** | Same contract text → same analysis (24h cache), preventing wasted AI calls |

## Verification Results

- ✅ `npm install` — succeeded (fixed multer `^1.4.5` → `^1.4.4-lts.1`)
- ✅ All 68 source files present and structured correctly
- ✅ All imports/exports cross-checked across layers
- ✅ Config files ([db.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/db.js), [redis.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/redis.js), [rabbitmq.js](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/config/rabbitmq.js)) export health check functions
- ✅ [asyncWrapper](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/utils/asyncWrapper.js#14-19) exports as direct function (matches route usage pattern)
- ✅ `dateHelper` exports [secondsUntilEndOfMonth](file:///c:/Users/vishal%20sanam/Downloads/LexAI/src/utils/dateHelper.js#42-52) (used by analysis service)

## How to Run

```bash
# Development (requires local MongoDB, Redis, RabbitMQ)
npm run dev              # API server
npm run dev:worker       # Worker process

# Docker (recommended — starts all 5 services)
npm run docker:up

# First-time setup
npm run seed             # Creates initial admin user
```
