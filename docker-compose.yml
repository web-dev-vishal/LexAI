services:
  # ─── Main API Server ──────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lexai-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      MONGO_URI: mongodb://mongodb:27017/lexai
      REDIS_HOST: redis
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      EMAIL_FROM: ${EMAIL_FROM}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    volumes:
      - ./src:/app/src
    restart: unless-stopped
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─── RabbitMQ Worker ──────────────────────────────────────────
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: lexai-worker
    environment:
      NODE_ENV: development
      MONGO_URI: mongodb://mongodb:27017/lexai
      REDIS_HOST: redis
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      AI_PRIMARY_MODEL: ${AI_PRIMARY_MODEL}
      AI_FALLBACK_MODEL: ${AI_FALLBACK_MODEL}
      ANALYSIS_QUEUE: ${ANALYSIS_QUEUE}
      ALERT_QUEUE: ${ALERT_QUEUE}
      DLX_EXCHANGE: ${DLX_EXCHANGE}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      EMAIL_FROM: ${EMAIL_FROM}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    restart: unless-stopped
    stop_grace_period: 30s

  # ─── MongoDB ──────────────────────────────────────────────────
  mongodb:
    image: mongo:7.0
    container_name: lexai-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped

  # ─── Redis ────────────────────────────────────────────────────
  redis:
    image: redis:7.2-alpine
    container_name: lexai-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # ─── RabbitMQ ─────────────────────────────────────────────────
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: lexai-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:
